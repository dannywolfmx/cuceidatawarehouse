<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<!--<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">-->
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../bower_components/multi-chart/multi-chart.html">


<link rel="stylesheet" href="../../bower_components/multi-chart/multichart.css">

<link rel="import" href="../../bower_components/d3-bundle-element/d3-element-multi.html">
<link rel="import" href="../../bower_components/multi-chart/multi-legend.html">
<link rel="import" href="../../bower_components/multi-chart/multi-selector.html">
<link rel="import" href="../../bower_components/multi-chart/shape/multi-shape-line.html">
<link rel="import" href="../../bower_components/multi-chart/chart/multi-chart-coordinate.html">
<link rel="stylesheet" href="../../bower_components/multi-chart/multichart.css">


<link rel="import" href="../../bower_components/neon-animation/animations/cascaded-animation.html">



<link rel="import" href="../login-component/inicio-panel.html">

<link rel="import" href="../elemento-archivo/elemento-archivo.html">

<dom-module id="interface-grafica-app">
  <template>

    <style is="custom-style">
       :host {
        margin: 0;
        display: block;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      #pieChart {
        height: 400px;
      }

      paper-drawer-panel {
        --paper-drawer-panel-left-drawer-container: {
          background-color: #333333;
        }
      }

      #lista-archivos {
        background-color: #333333;
        display: block;
        padding: 16px;
        --paper-card-header-text: {
          color: white;
        }
      }

      paper-menu {
        --paper-menu-background-color: {
          background-color: transparent;
        }
        --paper-menu: {}
      }

      paper-item:hover {
        opacity: 1;
        background-color: #555555;
      }

      paper-item {
        color: #fff;
        opacity: 0.7;
      }

      #datos-section {
        display: block;
        margin: 16px;
        --paper-card-content: {
          padding: 0;
        }
        ;
        --paper-card-header-text: {
          font-weight: bold;
          text-align: center;
          color: white !important;
        }
        --paper-card-actions: {
          padding: 0;
        }
      }

      vaadin-upload.thick-border {
        --primary-color: #396;
        --dark-primary-color: #063;
        --light-primary-color: #6c9;
        --error-color: darkred;
        border-bottom: 2px solid #ccc;
        padding: 14px;
        margin: 16px;
        background: #eee;
        border-radius: 0;
      }

      vaadin-upload.thick-border[dragover] {
        border-color: #396;
      }

      paper-toolbar {
        --paper-toolbar-background: #333333;
      }

      .direcciones {
        padding: 16px;
        border-bottom: 3px solid #396;
      }

      #lista-archivos {
        padding: 0;
        --paper-card-header: {}
        --paper-card-header-text: {
          color: #EEEEEE;
          text-align: center;
          font-weight: bold;
        }
      }

      neon-animated-pages {
        position: absolute;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
    </style>

    <!--guardamos los datos de la sesion en el navegador-->
    <iron-localstorage name="token" value="{{token}}"></iron-localstorage>
    <iron-localstorage name="usuario" value="{{usuario}}"></iron-localstorage>

    <!--Llamadas al servidor para la interacciÃ³n con los archivos-->
    <iron-ajax id="eliminararchivo" url="/eliminararchivo" method="POST" handle-as="json" on-response="actualizarArchivos"></iron-ajax>
    <iron-ajax id="seleccionararchivo" url="/damearchivo" method="POST" handle-as="json" on-response="muestraarchivo" on-error="errorAlObtenerArchivo"></iron-ajax>
    <iron-ajax id="traducirjson" url="/traductorjson" method="POST" handle-as="json" on-response="agregatraduccion"></iron-ajax>


    <neon-animated-pages class="flex" selected="[[uregistrado]]" entry-animation="fade-in-animation" exit-animation="fade-out-animation">

      <neon-animatable>
        <paper-drawer-panel>
          <paper-header-panel drawer>
            <paper-toolbar>

              <paper-icon-button icon="build"></paper-icon-button>
              <div class="title">[[usuario.rol]]</div>

            </paper-toolbar>
            <paper-menu>
              <paper-item>Subir archivos</paper-item>
            </paper-menu>

          </paper-header-panel>
          <paper-scroll-header-panel main>
            <paper-toolbar>
              <paper-icon-button icon="menu" on-tap="menuAction"></paper-icon-button>
              <div class="title">Titulo</div>
              <paper-icon-button icon="exit-to-app" on-tap="cerrarSecion"></paper-icon-button>

            </paper-toolbar>

            <!--Seccion para subir archivos-->
            <vaadin-upload class="thick-border" i18n="[[i18n]]" on-upload-response="uploadresponse" on-upload-before="agregarheader"
              id="fileupdate" name="sampleFile" target="/archivo" method="POST"></vaadin-upload>


            <paper-card id="datos-section" image="" elevation="1" animated-shadow="false">
              <div class="card-content">

                <paper-tabs selected="{{datosGraficas}}">
                  <paper-tab on-tap="prueba">Archivos</paper-tab>
                  <paper-tab>Tabla</paper-tab>
                  <paper-tab>Grafica</paper-tab>
                </paper-tabs>

                <neon-animated-pages class="flex" selected=[[datosGraficas]] entry-animation="fade-in-animation" exit-animation="fade-out-animation">

                  <paper-card id="lista-archivos" image="" elevation="1" animated-shadow="false">
                    <template is="dom-repeat" items="[[usuario.archivos]]">
                      <paper-item class="direcciones">
                        <elemento-archivo>
                          <paper-icon-button icon="view-list" on-tap="seleccionaarchivo"></paper-icon-button>
                          <paper-icon-button icon="delete" style="color: #E57373;" on-tap="eliminarArchivo"></paper-icon-button>
                          [[editaNombreDireccion(item.direccion)]]
                        </elemento-archivo>
                      </paper-item>
                    </template>
                  </paper-card>
                  <div>

                    <paper-icon-button icon="g-translate" style="color: blue;" on-tap="traducirArchivo"></paper-icon-button>
                    <vaadin-grid aria-label="Basic Binding Example" items="[[datosTabla]]">

                      <vaadin-grid-column width="50px" flex-grow="0">
                        <template class="header">#</template>
                        <template>[[index]]</template>
                        <!-- If necessary, the footer could be set using <template class="footer"> -->
                      </vaadin-grid-column>

                      <template is="dom-repeat" items="[[columnas]]" as="columna">
                        <vaadin-grid-column>
                          <template class="header">[[columna]]</template>
                          <template>[[get(columna,item)]]</template>
                        </vaadin-grid-column>

                      </template>
                    </vaadin-grid>
                  </div>
                  <neon-animatable>
                    <div id="grafica">

                      <multi-chart-coordinate id="chart" color-scale="{{colorScale}}" x-accessor-path="[[xAccessorPath]]" x-scale="{{xScale}}"
                        x-accessor="{{xAccessor}}" y-accessor-path="[[yAccessorPath]]" y-scale="{{yScale}}" y-accessor="{{yAccessor}}">
                        <multi-shape-line index="banana" height="[[height]]" x-accessor="[[xAccessor]]" y-accessor="[[yAccessor]]" x-scale="[[xScale]]"
                          y-scale="[[yScale]]" color-scale="[[colorScale]]"></multi-shape-line>
                        <h3 header>PRUEBA D3</h3>
                        <multi-legend legend chart-width="0" scale="[[colorScale]]" position="top-right"></multi-legend>
                        <multi-selector selection-type="brushX" width="[[width]]" height="[[height]]" x-scale="[[xScale]]" accessor="[[xAccessor]]"></multi-selector>
                      </multi-chart-coordinate>
                    </div>

                  </neon-animatable>
                </neon-animated-pages>



              </div>

            </paper-card>

          </paper-scroll-header-panel>
        </paper-drawer-panel>

      </neon-animatable>

      <neon-animatable>

        <inicio-panel usuario="{{usuario}}" token="{{token}}"></inicio-panel>


      </neon-animatable>
    </neon-animated-pages>
    <paper-toast id="toast"></paper-toast>
  </template>

  <script>

  </script>
  <script>
    Polymer({

      is: 'interface-grafica-app',
      behaviors: [
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimatableBehavior
      ],
      properties: {
        animationConfig: {

          value: function () {
            return {
              'entry': {
                name: 'fade-in-animation',
                node: this,
                nodeDelay: 0, // You can use this to delay animation between each node
                timing: { duration: 2000 }
              }
              ,
              'exit': [{
                name: 'slide-left-animation',
                node: this
              }
              ]
            }
          }
        }
        ,
        datos: {
          type: Array,
          value: []
        },
        loginPanel: {
          type: Boolean,
          value: 0
        },
        datosGraficas: {
          type: Number,
          value: 0
        },
        usuario: Object,
        token: {
          type: String,
          value: "",
          observer: "registrado"
        },
        uregistrado: {
          type: Number,
          value: 1
        },
        listaarchivos: {
          type: Array,
          value: []
        },
        datosTabla: {
          type: Array,
          value: []
        },
        columnas: {
          type: Array,
          value: []
        },
        nombrearchivo: {
          type: String,
          value: ""
        },
        i18n: {
          type: Object,
          value: {
            dropFiles: {
              one: 'Suelta el archivo aqui...',
              many: 'Suelta los archivos aqui...'
            },
            addFiles: {
              one: 'Selecciona un archivo',
              many: 'Selecciona los archivos'
            },
            cancel: 'Cancelar',
            error: {
              tooManyFiles: 'Demaciados archivos',
              fileIsTooBig: 'Archivo demaciado grande',
              incorrectFileType: 'Tipo incorrecto de archivos'
            },
            uploading: {
              status: {
                connecting: 'Conectando',
                stalled: 'Stalled.',
                processing: 'Procesando archivos...'
              },
              remainingTime: {
                prefix: 'Tiempo reamanente: ',
                unknown: 'Tiempo desconocido'
              },
              error: {
                serverUnavailable: 'Servidor no disponible',
                unexpectedServerError: 'Error desconocido en servidor',
                forbidden: 'Acceso prohibido'
              }
            },
            units: {
              size: ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
            },
            formatSize: function (bytes) {
              // returns the size followed by the best suitable unit
            },
            formatTime: function (seconds, [secs, mins, hours]) {
              // returns a 'HH:MM:SS' string
            }
          }
        }


      },
      ready: function () {


      },
      attached: function () {
        ////////////

        var chart = this.$.chart;
        var data;

        var keys = ['apple', 'banana', 'grape'];
        var n = 10;

        function rnd(size, keys, max) {
          return d3.range(size).map(function (d, i) {
            var value = {};
            var r = d3.randomUniform(max);
            keys.forEach(function (k) {
              value[k] = r();
            });
            return { key: i, value: value }
          });
        }

        var d1 = rnd(10, keys, 50);
        var d2 = rnd(10, keys, 50);

        var isD1 = false;

        chart.colorDomain = ['banana'];
        chart.xAccessorPath = 'key';
        chart.yAccessorPath = '+value.banana';
        chart.data = d1;

        // app.innerRadius = 45;
        // app.padAngle = 0.1;

        /////////




        self = this

        document.querySelector('vaadin-upload').addEventListener('upload-response', function (e) {
          //console.log(e.detail.xhr.response); 
          self.set("datos", e.detail.xhr.response)
        })

        document.querySelector('vaadin-upload').addEventListener('upload-response', function (e) {
          //console.log(e.detail.xhr.response); 
          self.set("datos", e.detail.xhr.response)
        })
        /*        var socket = io.connect('http://localhost:3001');
                socket.on('news', function (data) {
                  console.log(data);
                  self.set("datos", data)
                });*/

        this.playAnimation('entry');
        this.$.toast.text = "Bienvenido";
        this.$.toast.open();
      },
      registrado: function () {
        console.log(this.usuario);
        if ((this.token.length > 0)) {
          this.set("uregistrado", 0);
        } else {
          this.set("uregistrado", 1);
        }
      },
      agregarheader: function () {
        this.$.fileupdate.headers = {
          Authorization: "Bear " + this.token,
          correousuario: this.usuario.correo
        }

      },
      uploadresponse: function (e) {
        let respuesta = JSON.parse(e.detail.xhr.response).usuario
        this.usuario = respuesta
      },
      cerrarSecion: function () {
        this.set("usuario", "")
        this.set("token", "");
      },
      eliminarArchivo: function (idArchivo) {
        console.log(idArchivo);
        this.$.eliminararchivo.headers = {
          Authorization: "Bear " + this.token,
          idusuario: this.usuario._id,
          idarchivo: idArchivo.model.item._id,
          direccion: idArchivo.model.item.direccion
        }

        this.$.eliminararchivo.generateRequest();
      },
      actualizarArchivos: function (e) {
        this.set('usuario', e.detail.response.usuario)
      },
      seleccionaarchivo: function (idArchivo) {
        let direccion = idArchivo.model.item.direccion;
        this.$.seleccionararchivo.headers = {
          Authorization: "Bear " + this.token,
          direccion: idArchivo.model.item.direccion
        }
        this.$.seleccionararchivo.generateRequest();
        this.nombrearchivo = direccion;
      },
      muestraarchivo: function (e) {

        this.$.toast.close();

        this.$.toast.text = "Archivo listo"

        this.$.toast.open();
        let contenido = e.detail.response
        //console.log(contenido[0])
        this.columnas = Object.keys(contenido[0]);
        this.datosTabla = contenido;
        this.datosGraficas = 1;
      },
      errorAlObtenerArchivo: function () {
        this.$.toast.close();

        this.$.toast.text = "El archivo aun no esta listo!!!"

        this.$.toast.open()
      },
      traducirArchivo: function () {
        if (this.nombrearchivo === "") {
          this.$.toast.close();

          this.$.toast.text = "Despliega una archivo para traducirlo"

          this.$.toast.open();
        } else {
          this.$.toast.close();
          this.$.toast.text = "Traduciendo..."
          this.$.toast.open();

          this.$.traducirjson.headers = {
            Authorization: "Bear " + this.token,
            nombrearchivo: this.nombrearchivo
          }

          this.$.traducirjson.generateRequest()

        }
      },
      agregatraduccion: function (e) {
        this.$.toast.close();
        this.datosTabla = e.detail.response;

        this.$.toast.text = "Traduccion lista"

        this.$.toast.open();
      },
      editaNombreDireccion: function (nombre) {
        /*-Separamos la cadena por cada "/" que tenga,
          -Obtenemos el ultimo elemento de la lista
          -Separamos la cadena por cada "." que tenga
          -Obtenemos el primer elemento de la lista*/

        return nombre.split("/").pop().split(".").shift()

      }
    });
  </script>
</dom-module>